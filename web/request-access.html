<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSH Vault - Access Request</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --card-bg: #141414;
      --border: #2a2a2a;
      --text: #e5e5e5;
      --text-dim: #888;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container { max-width: 480px; width: 100%; }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
    }

    .logo { font-size: 48px; margin-bottom: 16px; }
    h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .subtitle { color: var(--text-dim); margin-bottom: 24px; }

    .agent-info {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: left;
    }

    .agent-info h3 {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .agent-info .value {
      font-family: monospace;
      font-size: 14px;
      color: var(--text);
      word-break: break-all;
      margin-bottom: 16px;
    }

    .agent-info .value:last-child { margin-bottom: 0; }

    .agent-info .name { color: var(--primary); font-weight: 600; font-size: 18px; }
    .agent-info .fingerprint { color: var(--warning); }

    .permissions {
      background: #0d0d0d;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
    }

    .permissions .tag {
      display: inline-block;
      background: #2a2a4a;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      margin: 2px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 12px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-primary:disabled {
      background: #333;
      cursor: not-allowed;
    }

    .btn-danger {
      background: transparent;
      border: 1px solid var(--error);
      color: var(--error);
    }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.1); }

    .status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
    }
    .status.success { background: rgba(34, 197, 94, 0.1); color: var(--success); }
    .status.error { background: rgba(239, 68, 68, 0.1); color: var(--error); }
    .status.info { background: rgba(59, 130, 246, 0.1); color: var(--primary); }

    .unlock-code {
      font-family: monospace;
      font-size: 24px;
      letter-spacing: 4px;
      color: var(--success);
      background: #0d0d0d;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }

    .hidden { display: none; }

    .host-input {
      width: 100%;
      padding: 12px;
      background: #0d0d0d;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: monospace;
      font-size: 14px;
      margin-top: 8px;
    }
    .host-input:focus {
      outline: none;
      border-color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="logo">üîë</div>
      <h1>Access Request</h1>
      <p class="subtitle">An agent is requesting host access</p>

      <div id="loading">Loading challenge...</div>

      <div id="agent-details" class="hidden">
        <div class="agent-info">
          <h3>Agent Name</h3>
          <div class="value name" id="agent-name"></div>

          <h3>Public Key</h3>
          <div class="value fingerprint" id="agent-fingerprint"></div>

          <h3>Allowed Hosts</h3>
          <input type="text" id="allowed-hosts" class="host-input" placeholder="*, dev-*, staging-*">
          <div style="margin-top: 8px; font-size: 12px; color: var(--text-dim);">
            Comma-separated patterns. Use * for all hosts.
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; color: var(--text-dim); font-size: 14px;">Master Password</label>
          <input type="password" id="master-password" class="host-input" placeholder="Enter master password">
        </div>

        <button id="approve-btn" class="btn btn-primary">
          üîê Approve with Passkey
        </button>
        <button id="deny-btn" class="btn btn-danger">
          ‚úï Deny Request
        </button>
      </div>

      <div id="result" class="hidden">
        <div id="result-status" class="status"></div>
        <div id="unlock-code" class="unlock-code hidden"></div>
      </div>
    </div>
  </div>

  <script>
    const challengeId = new URLSearchParams(window.location.search).get('challenge');
    
    let authOptions = null;
    let webauthnChallengeId = null;

    async function init() {
      if (!challengeId) {
        showError('No challenge ID provided');
        return;
      }

      try {
        // Fetch challenge details
        const res = await fetch(`/api/challenge/${challengeId}`);
        if (!res.ok) throw new Error('Challenge not found or expired');
        
        const data = await res.json();
        if (data.challenge.action !== 'request_access') {
          throw new Error('Invalid challenge type');
        }

        const reg = data.challenge.accessRequest;
        
        // Display agent info
        document.getElementById('agent-name').textContent = reg.name;
        document.getElementById('agent-fingerprint').textContent = reg.publicKey;
        
        // Pre-fill hosts input
        document.getElementById('allowed-hosts').value = reg.requestedHosts.join(', ');

        // Get auth options
        const authRes = await fetch('/api/auth/options', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        if (!authRes.ok) throw new Error('Failed to get auth options');
        const authData = await authRes.json();
        authOptions = authData.options;
        webauthnChallengeId = authData.challengeId;

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('agent-details').classList.remove('hidden');

      } catch (error) {
        showError(error.message);
      }
    }

    document.getElementById('approve-btn').addEventListener('click', async () => {
      const btn = document.getElementById('approve-btn');
      btn.disabled = true;
      btn.textContent = 'üîê Authenticating...';

      try {
        const password = document.getElementById('master-password').value;
        if (!password) { alert('Master password is required'); btn.disabled = false; btn.textContent = 'üîê Approve with Passkey'; return; }

        // WebAuthn authentication
        const credential = await navigator.credentials.get({
          publicKey: {
            ...authOptions,
            challenge: base64ToBuffer(authOptions.challenge),
            allowCredentials: authOptions.allowCredentials?.map(c => ({
              ...c,
              id: base64ToBuffer(c.id),
            })),
          },
        });

        // Get edited hosts
        const hostsInput = document.getElementById('allowed-hosts').value;
        const allowedHosts = hostsInput.split(',').map(h => h.trim()).filter(h => h);

        // Verify with server
        const verifyRes = await fetch('/api/auth/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            webauthnChallengeId,
            vaultChallengeId: challengeId,
            password,
            allowedHosts,  // Send edited hosts
            response: {
              id: credential.id,
              rawId: bufferToBase64(credential.rawId),
              type: credential.type,
              response: {
                authenticatorData: bufferToBase64(credential.response.authenticatorData),
                clientDataJSON: bufferToBase64(credential.response.clientDataJSON),
                signature: bufferToBase64(credential.response.signature),
              },
            },
          }),
        });

        if (!verifyRes.ok) throw new Error('Authentication failed');
        
        const result = await verifyRes.json();
        
        document.getElementById('agent-details').classList.add('hidden');
        document.getElementById('result').classList.remove('hidden');
        
        const statusEl = document.getElementById('result-status');
        statusEl.className = 'status success';
        
        if (result.autoUnlocked) {
          statusEl.innerHTML = '‚úÖ Access granted!<br><small>Agent notified automatically.</small>';
        } else {
          statusEl.textContent = '‚úÖ Access granted!';
        }
        
        if (result.unlockCode) {
          const codeEl = document.getElementById('unlock-code');
          codeEl.textContent = result.unlockCode;
          codeEl.classList.remove('hidden');
        }

      } catch (error) {
        btn.disabled = false;
        btn.textContent = 'üîê Approve with Passkey';
        showError(error.message);
      }
    });

    document.getElementById('deny-btn').addEventListener('click', () => {
      window.close();
    });

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('result').classList.remove('hidden');
      const statusEl = document.getElementById('result-status');
      statusEl.className = 'status error';
      statusEl.textContent = '‚ùå ' + message;
    }

    function base64ToBuffer(base64) {
      const str = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
      const bytes = new Uint8Array(str.length);
      for (let i = 0; i < str.length; i++) bytes[i] = str.charCodeAt(i);
      return bytes.buffer;
    }

    function bufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let str = '';
      for (const byte of bytes) str += String.fromCharCode(byte);
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    init();
  </script>
</body>
</html>
