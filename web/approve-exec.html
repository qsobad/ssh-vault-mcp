<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSH Vault - Approve Execution</title>
  <style>
    :root {
      --bg: #0a0a0a; --card-bg: #141414; --border: #2a2a2a;
      --text: #e5e5e5; --text-dim: #888; --primary: #3b82f6;
      --primary-hover: #2563eb; --success: #22c55e; --error: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .card {
      background: var(--card-bg); border: 1px solid var(--border);
      border-radius: 16px; padding: 32px; max-width: 520px; width: 100%; text-align: center;
    }
    .logo { font-size: 48px; margin-bottom: 16px; }
    h2 { margin-bottom: 8px; font-size: 22px; }
    .subtitle { color: var(--text-dim); margin-bottom: 24px; font-size: 14px; }
    .exec-info {
      background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; margin-bottom: 24px; text-align: left;
    }
    .exec-info .label { color: var(--text-dim); font-size: 12px; margin-bottom: 4px; }
    .exec-info .value { font-family: monospace; font-size: 13px; word-break: break-all; margin-bottom: 12px; }
    .exec-info .value:last-child { margin-bottom: 0; }
    .command-box {
      background: #1a1a2e; border: 1px solid #333; border-radius: 6px;
      padding: 12px; font-family: monospace; font-size: 13px;
      white-space: pre-wrap; word-break: break-all; text-align: left;
      color: #22c55e; max-height: 120px; overflow-y: auto;
    }
    .form-group { margin-bottom: 16px; text-align: left; }
    .form-group label { display: block; margin-bottom: 6px; color: var(--text-dim); font-size: 14px; }
    .form-group input {
      width: 100%; padding: 10px 12px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); font-size: 14px;
    }
    .form-group input:focus { outline: none; border-color: var(--primary); }
    .btn {
      padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer;
      font-size: 15px; font-weight: 600; transition: all 0.2s; width: 100%;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-danger { background: var(--error); color: white; margin-top: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .status { margin-top: 16px; font-size: 14px; }
    .status.success { color: var(--success); }
    .status.error { color: var(--error); }
    .status.warning { color: var(--warning); }
    #authSection { display: none; }
    .result-box {
      background: #0d1117; border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; margin-top: 16px; text-align: left; display: none;
    }
    .result-box .result-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px;
    }
    .result-box .exit-code { font-size: 12px; padding: 2px 8px; border-radius: 4px; }
    .exit-code.ok { background: #22c55e33; color: var(--success); }
    .exit-code.fail { background: #ef444433; color: var(--error); }
    .result-output {
      background: #000; border-radius: 4px; padding: 12px;
      font-family: monospace; font-size: 12px; white-space: pre-wrap;
      word-break: break-all; max-height: 300px; overflow-y: auto;
      color: #ccc;
    }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--text-dim);
      border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;
      vertical-align: middle; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 480px) {
      body { padding: 12px; }
      .card { padding: 24px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">‚ö°</div>
    <h2>Execute Command</h2>
    <p class="subtitle" id="subtitle">An agent wants to run a command on a remote host</p>

    <div id="loading">Loading...</div>

    <div id="execDetails" style="display: none;">
      <div class="exec-info">
        <div class="label">Host</div>
        <div class="value" id="execHost"></div>
        <div class="label">Command</div>
        <div class="command-box" id="execCommand"></div>
      </div>

      <div id="authSection">
        <div class="form-group">
          <label>Master Password</label>
          <input type="password" id="passwordInput" placeholder="Enter master password" autofocus>
        </div>
        <button class="btn btn-primary" id="authBtn" onclick="authenticate()">
          üîê Authenticate & Execute
        </button>
        <button class="btn btn-danger" onclick="rejectExec()">
          ‚úñ Reject
        </button>
      </div>

      <div id="executingStatus" style="display: none;">
        <p><span class="spinner"></span> <span id="execStatusText">Executing...</span></p>
      </div>

      <div class="result-box" id="resultBox"></div>
    </div>

    <div id="statusMsg" class="status" style="display: none;"></div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const requestId = params.get('id');

    function base64ToBuffer(base64) {
      const str = base64.replace(/-/g, '+').replace(/_/g, '/');
      const pad = str.length % 4 === 0 ? '' : '='.repeat(4 - (str.length % 4));
      const bin = atob(str + pad);
      return Uint8Array.from(bin, c => c.charCodeAt(0)).buffer;
    }
    function bufferToBase64(buf) {
      const bytes = new Uint8Array(buf);
      let str = '';
      bytes.forEach(b => str += String.fromCharCode(b));
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    if (!requestId) {
      document.getElementById('loading').textContent = 'No request ID provided';
    } else {
      loadRequest();
    }

    // Allow Enter key to submit
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.getElementById('authSection').style.display !== 'none') {
        authenticate();
      }
    });

    async function loadRequest() {
      try {
        const res = await fetch(`/api/vault/exec-request/${requestId}`);
        if (!res.ok) {
          const data = await res.json();
          showStatus(data.error || 'Request not found', 'error');
          document.getElementById('loading').style.display = 'none';
          return;
        }
        const data = await res.json();
        if (data.status !== 'pending') {
          showStatus(`Request already ${data.status}`, data.status === 'completed' ? 'success' : 'error');
          document.getElementById('loading').style.display = 'none';
          return;
        }
        document.getElementById('execHost').textContent = data.host;
        document.getElementById('execCommand').textContent = data.command;
        document.getElementById('loading').style.display = 'none';
        document.getElementById('execDetails').style.display = 'block';
        document.getElementById('authSection').style.display = 'block';
      } catch (err) {
        showStatus('Failed to load request', 'error');
        document.getElementById('loading').style.display = 'none';
      }
    }

    async function authenticate() {
      const password = document.getElementById('passwordInput').value;
      if (!password) {
        showStatus('Password required', 'error');
        return;
      }

      const btn = document.getElementById('authBtn');
      btn.disabled = true;
      btn.textContent = 'üîê Authenticating...';
      hideStatus();

      try {
        // Step 1: Get WebAuthn options
        const optionsRes = await fetch('/api/auth/options', { method: 'POST' });
        if (!optionsRes.ok) throw new Error('Failed to get auth options');
        const { options, challengeId } = await optionsRes.json();

        // Step 2: Passkey authentication
        const credential = await navigator.credentials.get({
          publicKey: {
            ...options,
            challenge: base64ToBuffer(options.challenge),
            allowCredentials: options.allowCredentials?.map(c => ({
              ...c, id: base64ToBuffer(c.id)
            }))
          }
        });

        btn.textContent = '‚ö° Approving & Executing...';

        // Step 3: Approve the exec request with passkey + password
        const approveRes = await fetch(`/api/vault/exec-request/${requestId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            password,
            webauthnChallengeId: challengeId,
            webauthnResponse: {
              id: credential.id,
              rawId: bufferToBase64(credential.rawId),
              type: credential.type,
              response: {
                clientDataJSON: bufferToBase64(credential.response.clientDataJSON),
                authenticatorData: bufferToBase64(credential.response.authenticatorData),
                signature: bufferToBase64(credential.response.signature),
                userHandle: credential.response.userHandle ? bufferToBase64(credential.response.userHandle) : null
              }
            }
          })
        });
        const approveData = await approveRes.json();

        if (!approveRes.ok) {
          showStatus(approveData.error || 'Approval failed', 'error');
          btn.disabled = false;
          btn.textContent = 'üîê Authenticate & Execute';
          return;
        }

        // Hide auth, show executing
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('executingStatus').style.display = 'block';

        if (approveData.status === 'completed') {
          showResult(approveData);
        } else if (approveData.status === 'executing') {
          document.getElementById('execStatusText').textContent = 'Command is executing...';
          // Poll for result
          pollResult();
        }
      } catch (err) {
        if (err.name === 'NotAllowedError') {
          showStatus('Passkey authentication cancelled', 'error');
        } else {
          showStatus(err.message || 'Authentication failed', 'error');
        }
        btn.disabled = false;
        btn.textContent = 'üîê Authenticate & Execute';
      }
    }

    async function pollResult() {
      const maxAttempts = 60; // 5 minutes with 5s interval
      for (let i = 0; i < maxAttempts; i++) {
        await new Promise(r => setTimeout(r, 2000));
        try {
          const res = await fetch(`/api/vault/exec-request/${requestId}`);
          const data = await res.json();
          if (data.status === 'completed' || data.status === 'failed') {
            showResult(data);
            return;
          }
          document.getElementById('execStatusText').textContent =
            data.status === 'executing' ? 'Command is executing...' : `Status: ${data.status}`;
        } catch { /* ignore */ }
      }
      showStatus('Request timed out', 'error');
    }

    function showResult(data) {
      document.getElementById('executingStatus').style.display = 'none';
      if (data.status === 'completed') {
        showStatus('‚úÖ Approved. Result sent to agent.', 'success');
      } else if (data.status === 'failed') {
        showStatus('‚ùå ' + (data.error || 'Execution failed'), 'error');
      } else {
        showStatus('‚ö†Ô∏è Command finished. Result sent to agent.', 'warning');
      }
    }

    async function rejectExec() {
      try {
        await fetch(`/api/vault/exec-request/${requestId}/reject`, { method: 'POST' });
        showStatus('Execution rejected', 'error');
        document.getElementById('authSection').style.display = 'none';
      } catch { showStatus('Failed to reject', 'error'); }
    }

    function showStatus(msg, type) {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.className = `status ${type}`;
      el.style.display = 'block';
    }
    function hideStatus() {
      document.getElementById('statusMsg').style.display = 'none';
    }
  </script>
</body>
</html>
