<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secret Vault - Create Secret</title>
  <style>
    :root {
      --bg: #0a0a0a; --card-bg: #141414; --border: #2a2a2a;
      --text: #e5e5e5; --text-dim: #888; --primary: #3b82f6;
      --primary-hover: #2563eb; --success: #22c55e; --error: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .card {
      background: var(--card-bg); border: 1px solid var(--border);
      border-radius: 16px; padding: 32px; max-width: 600px; width: 100%; text-align: center;
    }
    .logo { font-size: 48px; margin-bottom: 16px; }
    h2 { margin-bottom: 8px; font-size: 22px; }
    .subtitle { color: var(--text-dim); margin-bottom: 24px; font-size: 14px; }
    .secret-info {
      background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; margin-bottom: 24px; text-align: left;
    }
    .secret-info .label { color: var(--text-dim); font-size: 12px; margin-bottom: 4px; }
    .secret-info .value { font-family: monospace; font-size: 15px; margin-bottom: 8px; color: var(--warning); }
    .description { color: #9ca3af; margin-bottom: 12px; }
    .tag { background: #1a2a3a; color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    .form-group { margin-bottom: 16px; text-align: left; }
    .form-group label { display: block; margin-bottom: 6px; color: var(--text-dim); font-size: 14px; }
    .form-group input, .form-group textarea {
      width: 100%; padding: 10px 12px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); font-size: 14px; font-family: monospace;
    }
    .form-group textarea { min-height: 200px; resize: vertical; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
    .btn {
      padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer;
      font-size: 15px; font-weight: 600; transition: all 0.2s; width: 100%;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-danger { background: var(--error); color: white; margin-top: 8px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .status { margin-top: 16px; font-size: 14px; }
    .status.success { color: var(--success); }
    .status.error { color: var(--error); }
    #authSection { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">üìù</div>
    <h2>Create Secret</h2>
    <p class="subtitle">An agent requested creation of a new secret</p>

    <div id="loading">Loading request...</div>

    <div id="requestInfo" style="display:none">
      <div class="secret-info">
        <div class="label">Secret Name</div>
        <div class="value" id="secretName"></div>
        <div class="label">Tags</div>
        <div class="description" id="secretDesc"></div>
      </div>

      <div id="authSection">
        <div class="form-group">
          <label>Secret Content (Markdown)</label>
          <textarea id="content" placeholder="# Secret Name&#10;- host: 1.2.3.4&#10;- user: root&#10;- password: xxx"></textarea>
        </div>
        <div class="form-group">
          <label>Master Password</label>
          <input type="password" id="password" placeholder="Enter master password">
        </div>
        <button class="btn btn-primary" id="approveBtn" onclick="approve()">üîë Create with Passkey</button>
        <button class="btn btn-danger" onclick="reject()">‚úï Reject</button>
      </div>

      <div id="statusMsg" class="status"></div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const requestId = params.get('id');

    async function loadRequest() {
      try {
        const res = await fetch(`/api/secrets/create-request/${requestId}`);
        if (!res.ok) throw new Error('Request not found or expired');
        const data = await res.json();
        document.getElementById('secretName').textContent = data.name;
        const descEl = document.getElementById('secretDesc');
        descEl.textContent = data.description || "";
        document.getElementById('content').value = `# ${data.name}\n`;
        document.getElementById('loading').style.display = 'none';
        document.getElementById('requestInfo').style.display = 'block';
        document.getElementById('authSection').style.display = 'block';
      } catch (e) {
        document.getElementById('loading').textContent = 'Request not found or expired.';
      }
    }

    async function approve() {
      const password = document.getElementById('password').value;
      const content = document.getElementById('content').value;
      if (!password) { showStatus('Password required', 'error'); return; }
      if (!content.trim()) { showStatus('Content required', 'error'); return; }

      const btn = document.getElementById('approveBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Creating...';

      try {
        const optRes = await fetch('/api/auth/options', { method: 'POST' });
        const optData = await optRes.json();

        optData.options.challenge = base64urlToBuffer(optData.options.challenge);
        if (optData.options.allowCredentials) {
          optData.options.allowCredentials = optData.options.allowCredentials.map(c => ({
            ...c, id: base64urlToBuffer(c.id)
          }));
        }

        const assertion = await navigator.credentials.get({ publicKey: optData.options });
        const webauthnResponse = {
          id: assertion.id,
          rawId: bufferToBase64url(assertion.rawId),
          type: assertion.type,
          response: {
            authenticatorData: bufferToBase64url(assertion.response.authenticatorData),
            clientDataJSON: bufferToBase64url(assertion.response.clientDataJSON),
            signature: bufferToBase64url(assertion.response.signature),
          }
        };

        const res = await fetch(`/api/secrets/create-request/${requestId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            challengeId: optData.challengeId,
            response: webauthnResponse,
            password,
            content,
          }),
        });

        const data = await res.json();
        if (data.success) {
          showStatus('‚úì Secret created successfully!', 'success');
          btn.textContent = '‚úì Done';
        } else {
          throw new Error(data.error || 'Creation failed');
        }
      } catch (e) {
        showStatus(e.message, 'error');
        btn.disabled = false;
        btn.textContent = 'üîë Create with Passkey';
      }
    }

    async function reject() {
      await fetch(`/api/secrets/create-request/${requestId}/reject`, { method: 'POST' });
      showStatus('Request rejected.', 'error');
    }

    function showStatus(msg, type) {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.className = 'status ' + type;
    }

    function base64urlToBuffer(b64url) {
      const b64 = b64url.replace(/-/g, '+').replace(/_/g, '/');
      const pad = b64.length % 4 ? '='.repeat(4 - b64.length % 4) : '';
      const bin = atob(b64 + pad);
      return Uint8Array.from(bin, c => c.charCodeAt(0)).buffer;
    }

    function bufferToBase64url(buf) {
      const bytes = new Uint8Array(buf);
      let binary = '';
      bytes.forEach(b => binary += String.fromCharCode(b));
      return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    loadRequest();
  </script>
</body>
</html>
